<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AION Protein Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, sans-serif;
            background: #1a1a2e;
            color: white;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .panel {
            width: 300px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
        }

        h2 {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            margin: 20px 0 10px;
            letter-spacing: 1px;
        }

        h2:first-child {
            margin-top: 0;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            background: #0f3460;
            border: 1px solid #1e5f74;
            border-radius: 6px;
            color: white;
            margin-bottom: 10px;
            font-family: monospace;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #e94560;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        button:hover {
            background: #ff6b6b;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #0f3460;
        }

        .stat-value {
            color: #4ecdc4;
            font-weight: bold;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        #viewer {
            flex: 1;
            background: radial-gradient(circle at center, #1a1a2e, #0a0a15);
        }

        .hint {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="panel">
            <h2>üß¨ Sequence</h2>
            <input type="text" id="seq" value="ACDEFGHIKLMNPQRSTVWY">
            <button onclick="fold()">Fold Protein</button>

            <h2>üìä Stats</h2>
            <div class="stat"><span>Length</span><span class="stat-value" id="sLen">-</span></div>
            <div class="stat"><span>Helix</span><span class="stat-value" id="sHelix">-</span></div>
            <div class="stat"><span>Sheet</span><span class="stat-value" id="sSheet">-</span></div>
            <div class="stat"><span>Loop</span><span class="stat-value" id="sLoop">-</span></div>

            <h2>üé® Colors</h2>
            <div class="legend-item">
                <div class="legend-dot" style="background:#e94560"></div>Œ±-Helix
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background:#f9ca24"></div>Œ≤-Sheet
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background:#4ecdc4"></div>Loop
            </div>

            <h2>üìã Examples</h2>
            <button style="background:#0f3460" onclick="loadEx('helix')">Œ±-Helix (40 aa)</button>
            <button style="background:#0f3460" onclick="loadEx('mixed')">Mixed (60 aa)</button>
            <button style="background:#0f3460" onclick="loadEx('long')">Lysozyme (129 aa)</button>
        </div>
        <canvas id="viewer"></canvas>
    </div>

    <div class="hint">üñ±Ô∏è Drag to rotate ‚Ä¢ Scroll to zoom</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        const EXAMPLES = {
            helix: 'AEAAAKEAAAKEAAAKEAAAKEAAAKEAAAKEAAAKEAAAK',
            mixed: 'AEAAAKEAAAKPGVVVVIVVVPAEAAAKEAAAKPGVVVVIVVVPAEAAAKEAAAK',
            long: 'KVFGRCELAAAMKRHGLDNYRGYSLGNWVCAAKFESNFNTQATNRNTDGSTDYGILQINSRWWCNDGRTPGSRNLCNIPCSALLSSDITASVNCAKKIVSDGNGMNAWVAWRNRCKGTDVQAWIRGCRL'
        };

        // Chou-Fasman propensities
        const AA = {
            'A': { h: 1.42, s: 0.83 }, 'R': { h: 0.98, s: 0.93 }, 'N': { h: 0.67, s: 0.89 }, 'D': { h: 1.01, s: 0.54 },
            'C': { h: 0.70, s: 1.19 }, 'E': { h: 1.51, s: 0.37 }, 'Q': { h: 1.11, s: 1.10 }, 'G': { h: 0.57, s: 0.75 },
            'H': { h: 1.00, s: 0.87 }, 'I': { h: 1.08, s: 1.60 }, 'L': { h: 1.21, s: 1.30 }, 'K': { h: 1.16, s: 0.74 },
            'M': { h: 1.45, s: 1.05 }, 'F': { h: 1.13, s: 1.38 }, 'P': { h: 0.57, s: 0.55 }, 'S': { h: 0.77, s: 0.75 },
            'T': { h: 0.83, s: 1.19 }, 'W': { h: 1.08, s: 1.37 }, 'Y': { h: 0.69, s: 1.47 }, 'V': { h: 1.06, s: 1.70 }
        };

        const COLORS = { helix: 0xe94560, sheet: 0xf9ca24, loop: 0x4ecdc4 };

        let scene, camera, renderer, controls, protein;

        function init() {
            const canvas = document.getElementById('viewer');

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, canvas.clientWidth / canvas.clientHeight, 1, 1000);
            camera.position.z = 100;

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Simple lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const light = new THREE.DirectionalLight(0xffffff, 0.8);
            light.position.set(1, 1, 1);
            scene.add(light);

            protein = new THREE.Group();
            scene.add(protein);

            window.addEventListener('resize', () => {
                camera.aspect = canvas.clientWidth / canvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            });

            animate();
            fold();
        }

        function animate() {
            requestAnimationFrame(animate);
            protein.rotation.y += 0.003;
            controls.update();
            renderer.render(scene, camera);
        }

        function predictSS(seq) {
            const ss = [];
            for (let i = 0; i < seq.length; i++) {
                let h = 0, s = 0;
                for (let j = Math.max(0, i - 2); j < Math.min(seq.length, i + 3); j++) {
                    const p = AA[seq[j]] || { h: 1, s: 1 };
                    h += p.h; s += p.s;
                }
                h /= 5; s /= 5;
                if (seq[i] === 'P') h *= 0.3;
                ss.push(h > 1.1 && h > s ? 'helix' : s > 1.15 ? 'sheet' : 'loop');
            }
            return ss;
        }

        function buildCoords(seq, ss) {
            const pts = [];

            for (let i = 0; i < seq.length; i++) {
                let x, y, z;

                if (ss[i] === 'helix') {
                    // Alpha helix: 3.6 res/turn, radius 2.3√Ö, rise 1.5√Ö
                    const angle = i * (2 * Math.PI / 3.6);
                    x = 2.3 * Math.cos(angle);
                    y = 2.3 * Math.sin(angle);
                    z = i * 1.5;
                } else if (ss[i] === 'sheet') {
                    // Extended strand
                    x = 0;
                    y = (i % 2) * 0.5;
                    z = i * 3.3;
                } else {
                    // Loop with gentle curve
                    const prev = pts[i - 1] || { x: 0, y: 0, z: 0 };
                    const angle = i * 0.4 + Math.sin(i * 0.3) * 0.8;
                    x = prev.x + Math.cos(angle) * 1.5;
                    y = prev.y + Math.sin(angle) * 1.5;
                    z = i * 2.5;
                }

                pts.push({ x, y, z, ss: ss[i] });
            }

            return pts;
        }

        function fold() {
            const seq = document.getElementById('seq').value.toUpperCase().replace(/[^A-Z]/g, '');
            if (!seq) return;

            const ss = predictSS(seq);
            const coords = buildCoords(seq, ss);

            // Stats
            const cnt = { helix: 0, sheet: 0, loop: 0 };
            ss.forEach(s => cnt[s]++);

            document.getElementById('sLen').textContent = seq.length;
            document.getElementById('sHelix').textContent = Math.round(cnt.helix / seq.length * 100) + '%';
            document.getElementById('sSheet').textContent = Math.round(cnt.sheet / seq.length * 100) + '%';
            document.getElementById('sLoop').textContent = Math.round(cnt.loop / seq.length * 100) + '%';

            render(coords);
        }

        function render(coords) {
            // Clear
            while (protein.children.length) protein.remove(protein.children[0]);

            // Center
            let cx = 0, cy = 0, cz = 0;
            coords.forEach(c => { cx += c.x; cy += c.y; cz += c.z; });
            cx /= coords.length; cy /= coords.length; cz /= coords.length;

            // Create smooth spline through all points
            const points = coords.map(c => new THREE.Vector3(c.x - cx, c.y - cy, c.z - cz));

            if (points.length < 2) return;

            // Create one continuous smooth tube colored by secondary structure
            const curve = new THREE.CatmullRomCurve3(points);
            const numSegments = coords.length * 10;
            const curvePoints = curve.getPoints(numSegments);

            // Draw colored segments
            for (let i = 0; i < curvePoints.length - 1; i++) {
                const coordIdx = Math.floor(i / 10);
                const ss = coords[Math.min(coordIdx, coords.length - 1)].ss;
                const color = COLORS[ss];

                // Create small tube segment
                const segCurve = new THREE.LineCurve3(curvePoints[i], curvePoints[i + 1]);
                const geo = new THREE.TubeGeometry(segCurve, 1, 0.8, 8, false);
                const mat = new THREE.MeshLambertMaterial({ color });
                protein.add(new THREE.Mesh(geo, mat));
            }

            // Adjust camera distance
            camera.position.z = Math.max(60, coords.length * 0.7);
        }

        function loadEx(name) {
            document.getElementById('seq').value = EXAMPLES[name];
            fold();
        }

        init();
    </script>
</body>

</html>